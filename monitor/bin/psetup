#!/bin/bash
# Pmon database setup tool
# $Id$
# $URL$
#*********************************************************
# Process Command Line Arguments
#*********************************************************

#*********************************************************
# Determine whether the option was called
#*********************************************************
for i in "$@"; do
   case "$i" in
      -y) force=yes ;;
   esac
done

if (( ${#@} == 0 ))
then
   help=yes
fi

function usage
{
cat <<EOF
 Usage: psetup [-h] 
               [-f {dbfile}] 
               [-l {loadfile}] 
               [-y for force overwrite] 
	       [-n {nodename}]
               [-d for all defaults]

EOF
}
#*********************************************************
# Parse Options
#*********************************************************
while getopts ":hdyf:l:n:" opt; do
   case "$opt" in
      h ) help=yes ;;
      d ) defaults=yes ;;
      f ) fname=$OPTARG ;;
      l ) loadfile=$OPTARG ;;
      n ) myhost=$OPTARG ;;
      y ) force=yes ;;
      \?|*) usage
          exit 1 ;;
   esac
done

if [ "$help" == "yes" ]
then
   echo "$0: help option called, program exiting"
   usage
   echo "See http://lservices.vrdc.cornell.edu/mediawiki/index.php/KevPMON for more info"
   exit 0
fi

#-------------------- configuration --------------------
function default_config
{
# where is pmon configured
[[ -z $myhost ]] && myhost=$(hostname)
confdir=$(dirname $(pwd $(dirname $0)))
[[ -z $PMON_CONF_LOC ]] && PMON_CONF_LOC=${confdir}/library/config
[[ -z $PMON_RUN_LOC ]] && PMON_RUN_LOC=${confdir}/run/$myhost
[[ -z $PMON_CONF ]] && PMON_CONF=$PMON_CONF_LOC/pmon.${myhost}.conf
[[ -f $PMON_CONF ]] || PMON_CONF=$PMON_CONF_LOC/pmon.conf
# if this still does not exist, then lets do something about it
[[ -f $PMON_CONF ]] || create_pmon_conf
source $PMON_CONF
# where is the DB - could be overridden?
[[ -z $DB_LOC ]] && DB_LOC=${confdir}/run/db
# this should be parsed from the config file
#[[ -z $dbname ]] && dbname=rlist.db
[[ -f $DB_LOC/$dbname ]] && exists_db="[WARNING: exists!]" || exists_db=
# the file defining the DB structure
[[ -z $createfile ]] && createfile=$PMON_CONF_LOC/create_rlist_db.sqlite
[[ -f $createfile ]] && exists_createfile="[OK]" || exists_createfile="[WARNING: not there]"
# the file to load into the DB
[[ -z $loadfile ]] && loadfile=$PMON_CONF_LOC/load_jobs.sql
[[ -f $loadfile ]] && exists_loadfile="[OK]" || exists_loadfile="[WARNING: not there]"

umask $pmask
}

#-------------------- create pmon conf --------------------
function create_pmon_conf
{
# when we are here, we should have been called from default_config
# with a missing pmon.conf

PMON_CONF_TEMPLATE=$PMON_CONF_LOC/pmon.conf.template
jdir=${confdir}/
cp $PMON_CONF_TEMPLATE    $PMON_CONF
echo " pmon.conf created at $PMON_CONF"
echo " Customized to your needs."
echo " Then re-run this setup program again."
echo "Exiting."
exit 0

}

#-------------------- print info --------------------
function print_info
{
cat <<EOF

  $0 - setting up the database for PMON

  Hostname               : $myhost
  PMON configuration     : $PMON_CONF
  PMON run location      : $PMON_RUN_LOC
  
  Location of database   : $DB_LOC/$dbname $exists_db
  Location of create file: $createfile $exists_createfile
  Location of load file  : $loadfile $exists_loadfile

EOF

if [[ ! $force = yes ]] 
then
    echo "If this is correct, press ENTER to continue, CTRL-C to abort"
    read
fi


}

#*********************************************************
#Trap Errors
#*********************************************************

function errtrap {
   es=$?
   cmd=$(sed -n -e "${1},${1} p" ${cdir}/bin/$0)
   echo "ERROR line $1: $cmd"
   echo "ERROR line $1: Command exited with status $es"
}
trap 'errtrap $LINENO' ERR


#-------------------- create db --------------------
function create_db
{
if [[ ! -z $exists_db ]]
then
   echo "Warning: the DB $DB_LOC/$dbname will be overwritten."
   if [[ ! $force = yes ]] 
   then
     echo "If this is OK, press ENTER to continue, CTRL-C to abort"
     read
     rm -i $DB_LOC/$dbname
   fi
fi
umask $pmask
touch $DB_LOC/$dbname
sqlite3  $DB_LOC/$dbname < $createfile
}

#--------------------create runtime locations --------------------
function create_runloc
{
if [[ ! -d $PMON_RUN_LOC/log ]]
then
  echo "  Creating $PMON_RUN_LOC/log"
  mkdir -p  $PMON_RUN_LOC/log
fi
if [[ ! -d $PMON_RUN_LOC/pid ]]
then
  echo "  Creating $PMON_RUN_LOC/pid"
  mkdir -p  $PMON_RUN_LOC/pid
fi
if [[ ! -d $PMON_RUN_LOC/log || ! -d $PMON_RUN_LOC/pid ]]
then
    echo "Problem creating $PMON_RUN_LOC log or pid directory"
    echo "Exiting"
    exit 2
else
    echo "Success."
fi

}

#--------------------create jobdir --------------------
function create_jobdir
{
if [[ ! -d $jobdir ]]
then
  echo "  Creating jobdir $jobdir"
  mkdir -p  $jobdir
fi
if [[ ! -d $jobdir ]]
then
    echo "Problem creating jobdir directory"
    echo "Exiting"
    exit 2
else
    echo "Success."
fi

}

#-------------------- load db --------------------
function load_db
{
sqlite3  $DB_LOC/$dbname < $loadfile
}

#-------------------- check db --------------------
function check_db
{
numinserts=$(grep "INSERT into jobs" $loadfile| wc -l)
numjobs=$(sqlite3 $DB_LOC/$dbname "SELECT COUNT(*) FROM JOBS")
[[ $numinserts = $numjobs ]] && load_success=OK || load_success=ERROR
queried_conf=$(sqlite3 $DB_LOC/$dbname "SELECT node_conf FROM nodeaction WHERE node='$myhost';")

echo "------------------------------------------------------------"
echo "  Loadfile has $numinserts inserts into jobs table."
echo "  Database has $numjobs entries in jobs table."
echo "  Load status: $load_success"
echo ""
if [[ ! -d $PMON_RUN_LOC/log || ! -d $PMON_RUN_LOC/pid ]]
then
    echo "Problem creating $PMON_RUN_LOC log or pid directory"
    echo "Exiting"
    exit 2
else
    echo "  Directories: $PMON_RUN_LOC exists."
fi
if [[ ! -z $queried_conf ]]
then
 echo "  Node $myhost is using $queried_conf"
#else
#echo "  Node $myhost not found in table NODEACTION: PROBLEM"
fi
echo "------------------------------------------------------------"


}

#-------------------- insert node into db --------------------
function insert_node
{
sqlite3 $DB_LOC/$dbname "begin; INSERT into nodeaction (node, node_conf) VALUES ('$myhost','$PMON_CONF'); commit;"
}

#-------------------- now run it all --------------------


default_config
print_info
create_runloc
create_jobdir
create_db
load_db
#insert_node
check_db


